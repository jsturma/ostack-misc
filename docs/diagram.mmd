sequenceDiagram
  autonumber
  actor Runner as User or Cron
  participant S as protect-ostack.sh
  participant K as Keystone
  participant N as Nova
  participant C as Cinder
  participant G as Glance
  participant FS as Filesystem

  Runner->>S: Run with CLI args
  S->>S: Check deps (curl, jq)<br/>Parse args<br/>mkdir -p BACKUP_DIR

  S->>K: POST /auth/tokens (user/pass + project scope)
  K-->>S: X-Subject-Token + service catalog
  S->>S: Discover Cinder/Nova/Glance endpoints<br/>(from catalog if not provided)

  alt discover-all
    S->>N: GET /servers?all_tenants=1&limit=1000
    N-->>S: servers list (paged)
  else vm-list
    loop each VM name
      S->>N: GET /servers?name=<vm_name>
      N-->>S: server id
    end
  end

  loop each VM (name,id)
    S->>N: GET /servers/<id> (validate id,name,status)
    N-->>S: server details (status)
    alt unsupported status or invalid server
      S-->>Runner: skip VM
    else supported
      opt name filter
        S->>S: match --vm-filter
      end
      opt tag/metadata filter
        S->>N: GET /servers/<id>/tags
        N-->>S: tags[]
        S->>N: GET /servers/<id>/metadata
        N-->>S: metadata{}
        S->>S: apply --vm-tags (tags and/or metadata)
      end

      S->>FS: write vm-config.json (server details)
      S->>FS: write vm-tags.json (tags[])
      S->>FS: write vm-metadata.json (metadata{})

      S->>C: GET /volumes?all_tenants=1
      C-->>S: volumes list (attachments)
      alt no attached volumes
        S-->>Runner: done VM
      else volumes found
        loop each volume
          S->>C: POST /snapshots
          C-->>S: snapshot id
          S->>C: Poll snapshot status until available
          S->>C: POST /volumes (from snapshot)
          C-->>S: temp volume id
          S->>C: Poll volume status until available
          S->>G: POST /images (disk_format=DISK_FORMAT)
          G-->>S: image id
          S->>G: Poll image status until active
          S->>G: GET /images/<id>/file
          G-->>S: image bytes
          S->>FS: write volume.<format>
          S->>G: DELETE image
          S->>C: DELETE temp volume
          S->>C: DELETE snapshot
        end
      end
    end
  end

  S-->>Runner: ALL BACKUPS COMPLETED
